automation:
  - id: kitchen_motion_snapshots
    alias: "Security ‚Ä¢ Kitchen motion ‚Üí snapshots (3 photos, 30min cooldown)"
    mode: single
    trigger:
      - platform: webhook
        webhook_id: ipwebcam_kitchen_motion

    condition:
      # 1) –ø—Ä–æ—à–ª–æ –ª–∏ 30 –º–∏–Ω—É—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –§–û–¢–û–°–ï–°–°–ò–ò
      - condition: template
        value_template: >
          {% set last = state_attr('input_datetime.last_kitchen_photos', 'timestamp') | float(0) %}
          {{ (as_timestamp(now()) - last) > 1800 }}

      # 2) –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–±—è –Ω–µ—Ç –¥–æ–º–∞
      - condition: state
        entity_id: binary_sensor.andrey_home_final
        state: "off"

    action:
      # —Ñ–∏–∫—Å–∏—Ä—É–µ–º –º–æ–º–µ–Ω—Ç —Å—Ä–∞–±–æ—Ç–∫–∏ –∏ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤
      - variables:
          ts: "{{ now().timestamp() | int }}"
          pic1: "/config/www/pics/kitchen_1_{{ ts }}.jpg"
          pic2: "/config/www/pics/kitchen_2_{{ ts }}.jpg"
          pic3: "/config/www/pics/kitchen_3_{{ ts }}.jpg"

      # –ü–†–û–ë–ù–´–ô —Å–Ω–∏–º–æ–∫ ‚Äî —Ç–æ–ª—å–∫–æ —á—Ç–æ–±—ã —Ä–∞–∑–±—É–¥–∏—Ç—å –∫–∞–º–µ—Ä—É
      - service: camera.snapshot
        data:
          entity_id: camera.kitchen_cam_motioneye
          filename: "/config/www/pics/kitchen_warmup.jpg"

      # —á—É—Ç—å –∂–¥—ë–º, —á—Ç–æ–±—ã –ø–æ—Ç–æ–∫ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è
      - delay: "00:00:02"

      # —Ñ–æ—Ç–æ ‚Ññ1 (—É–∂–µ —Ä–µ–∞–ª—å–Ω–æ–µ, –ø–æ–π–¥—ë—Ç –≤ Telegram)
      - service: camera.snapshot
        data:
          entity_id: camera.kitchen_cam_motioneye
          filename: "{{ pic1 }}"
      - delay: "00:00:08"

      # —Ñ–æ—Ç–æ ‚Ññ2
      - service: camera.snapshot
        data:
          entity_id: camera.kitchen_cam_motioneye
          filename: "{{ pic2 }}"
      - delay: "00:00:08"

      # —Ñ–æ—Ç–æ ‚Ññ3
      - service: camera.snapshot
        data:
          entity_id: camera.kitchen_cam_motioneye
          filename: "{{ pic3 }}"

      # –∂–¥—ë–º, —á—Ç–æ–±—ã –¢–†–ò —Ñ–∞–π–ª–∞ 100% —É—Å–ø–µ–ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
      - delay: "00:00:50"

      # üîí —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —Ç—ã –≤—Å—ë –µ—â—ë –Ω–µ –¥–æ–º–∞?
      - condition: state
        entity_id: binary_sensor.andrey_home_final
        state: "off"

      # –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ñ–æ—Ç–æ—Å–µ—Å—Å–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã —Ä–µ–∞–ª—å–Ω–æ –±—É–¥–µ–º —Å–ª–∞—Ç—å —Ñ–æ—Ç–æ)
      - service: input_datetime.set_datetime
        data:
          entity_id: input_datetime.last_kitchen_photos
          timestamp: "{{ ts }}"

      # –æ—Ç–ø—Ä–∞–≤–∫–∞ 1/3
      - service: telegram_bot.send_photo
        data:
          target: 390171493            # chat_id
          file: "{{ pic1 }}"
          caption: "–î–≤–∏–∂–µ–Ω–∏–µ –Ω–∞ –∫—É—Ö–Ω–µ (1/3)"

      - delay: "00:00:05"

      # –æ—Ç–ø—Ä–∞–≤–∫–∞ 2/3
      - service: telegram_bot.send_photo
        data:
          target: 390171493
          file: "{{ pic2 }}"
          caption: "–î–≤–∏–∂–µ–Ω–∏–µ –Ω–∞ –∫—É—Ö–Ω–µ (2/3)"

      - delay: "00:00:05"

      # –æ—Ç–ø—Ä–∞–≤–∫–∞ 3/3
      - service: telegram_bot.send_photo
        data:
          target: 390171493
          file: "{{ pic3 }}"
          caption: "–î–≤–∏–∂–µ–Ω–∏–µ –Ω–∞ –∫—É—Ö–Ω–µ (3/3)"
